IF OBJECT_ID('PS_SD040_04') IS NOT NULL
BEGIN
	DROP PROC PS_SD040_04
END
GO
--EXEC PS_SD040_04 '10001'
CREATE PROC PS_SD040_04
(
	@CardCode NVARCHAR(100)
)
AS
BEGIN
	DECLARE @MONEY01 AS BIGINT
	DECLARE @MONEY02 AS BIGINT
	DECLARE @MONEY03 AS BIGINT
	
	SELECT 
		@MONEY01 = CreditLine - Balance 
	FROM 
		[OCRD] 
	WHERE 
		CardCode = @CardCode

	SELECT 
		@MONEY02 = PS_SD080L.U_RequestP
	FROM 
		[@PS_SD080H] PS_SD080H LEFT JOIN [@PS_SD080L] PS_SD080L ON PS_SD080H.DocEntry = PS_SD080L.DocEntry 
	WHERE 
		CONVERT(NVARCHAR,PS_SD080H.U_DocDate,112) = CONVERT(NVARCHAR,GETDATE(),112)
		AND PS_SD080L.U_CardCode = @CardCode
		AND PS_SD080H.U_OkYN = 'Y'
		AND PS_SD080H.Canceled = 'N'
		
	SELECT
		@MONEY03 = SUM(PS_SD030L.U_LinTotal)
	FROM
		[@PS_SD030H] PS_SD030H
		LEFT JOIN [@PS_SD030L] PS_SD030L ON PS_SD030H.DocEntry = PS_SD030L.DocEntry
	WHERE
		CONVERT(NVARCHAR,PS_SD030H.U_DocDate,112) = CONVERT(NVARCHAR,GETDATE(),112)
		AND PS_SD030H.U_CardCode = @CardCode
		AND PS_SD030H.Canceled = 'N'
		
	SELECT @MONEY01 + @MONEY02 - @MONEY03
END