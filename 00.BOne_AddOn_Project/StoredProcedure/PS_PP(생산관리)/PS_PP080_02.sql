IF OBJECT_ID('PS_PP080_02') IS NOT NULL
BEGIN
	DROP PROC PS_PP080_02
END
GO
--EXEC PS_PP080_02 '1','101'
CREATE PROC PS_PP080_02
(
	@PP030No NVARCHAR(100),
	@OrdGbn NVARCHAR(50)
)
AS
BEGIN	
	IF @OrdGbn IN('101','107') --휘팅,엔드베어링일때
	BEGIN
		SELECT 
			CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) AS PP030No,
			PS_PP030H.U_OrdGbn AS OrdGbn, --작업구분
			PS_PP030H.U_OrdNum AS OrdNum,
			PS_PP030H.U_OrdSub1 AS OrdSub1,
			PS_PP030H.U_OrdSub2 AS OrdSub2,
			PS_PP030H.DocEntry AS PP030HNo,
			PS_PP030M.LineId AS PP030MNo,
			PS_PP030H.U_SjNum AS ORDRNo,
			PS_PP030H.U_SjLine AS RDR1No,
			PS_PP030H.U_BPLId AS BPLId,
			PS_PP030H.U_ItemCode AS ItemCode,
			PS_PP030H.U_ItemName AS ItemName,
			PS_PP030M.U_CpCode AS CpCode,
			PS_PP030M.U_CpName AS CpName,
			(SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0) 
			AS BQty,
			CASE WHEN ISNULL((SELECT U_CpUnWt FROM [@PS_PP004H] WHERE U_ItemCode = PS_PP030H.U_ItemCode AND U_CpCode = PS_PP030M.U_CpCode),0) = 0 
			THEN
			((SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0)) 
			ELSE			
			((SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0)) * ISNULL((SELECT U_CpUnWt/1000 FROM [@PS_PP004H] WHERE U_ItemCode = PS_PP030H.U_ItemCode AND U_CpCode = PS_PP030M.U_CpCode),0)
			END
			AS BWeight,
			0 AS PQty,
			0 AS PWeight,
			0 AS YQty,
			0 AS YWeight,
			0 AS NQty,
			0 AS NWeight,			
			(SELECT DFLTWH FROM [OITM] WHERE ITEMCODE = PS_PP030H.U_ItemCode) AS WhsCode,
			(SELECT WhsName FROM [OWHS] WHERE WhsCode = (SELECT DFLTWH FROM [OITM] WHERE ITEMCODE = PS_PP030H.U_ItemCode)) AS WhsName,
			'' AS BatchNum,
			'' AS LineId
		FROM
			[@PS_PP030H] PS_PP030H
			LEFT JOIN [@PS_PP030M] PS_PP030M ON PS_PP030H.DocEntry = PS_PP030M.DocEntry			
			LEFT JOIN
			(SELECT
				PS_PP070L.U_PP030HNo AS PP030HNo,
				PS_PP070L.U_PP030MNo AS PP030MNo,
				SUM(PS_PP070L.U_SelQty) AS SelQty,
				SUM(PS_PP070L.U_SelWt) AS SelWt
			FROM
				[@PS_PP070H] PS_PP070H
				LEFT JOIN [@PS_PP070L] PS_PP070L ON PS_PP070H.DocEntry = PS_PP070L.DocEntry
			WHERE
				PS_PP070H.Canceled = 'N'
			GROUP BY
				PS_PP070L.U_PP030HNo,
				PS_PP070L.U_PP030MNo
			) PS_PP070 ON PS_PP070.PP030HNo = PS_PP030H.DocEntry AND PS_PP070.PP030MNo = PS_PP030M.LineId 
				AND @OrdGbn = '101' --휘팅벌크포장인경우 이므로 휘팅만 해당
			LEFT JOIN
			(SELECT
				PS_PP080L.U_PP030HNo AS PP030HNo,
				PS_PP080L.U_PP030MNo AS PP030MNo,
				SUM(PS_PP080L.U_PQty) AS SelQty,
				SUM(PS_PP080L.U_PWeight) AS SelWt
			FROM
				[@PS_PP080H] PS_PP080H
				LEFT JOIN [@PS_PP080L] PS_PP080L ON PS_PP080H.DocEntry = PS_PP080L.DocEntry
			WHERE
				PS_PP080H.Canceled = 'N'
			GROUP BY
				PS_PP080L.U_PP030HNo,
				PS_PP080L.U_PP030MNo
			) PS_PP080 ON PS_PP080.PP030HNo = PS_PP030H.DocEntry AND PS_PP080.PP030MNo = PS_PP030M.LineId
		WHERE
			PS_PP030H.Canceled = 'N'
			AND (SELECT COUNT(*) FROM [@PS_PP040H] PS_PP040H LEFT JOIN [@PS_PP040L] PS_PP040L ON PS_PP040H.DocEntry = PS_PP040L.DocEntry WHERE PS_PP040H.Canceled = 'N' AND PS_PP040L.U_PP030HNo = PS_PP030H.DocEntry AND PS_PP040L.U_PP030MNo = PS_PP030M.LineId) > 0
			AND PS_PP030H.U_OrdGbn IN('101','107') --휘팅,엔드베어링
			AND PS_PP030M.U_ResultYN = 'Y' --실적포인트	
			AND PS_PP030H.U_OrdGbn = @OrdGbn --휘팅,멀티,엔드베어링	
			AND CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) = @PP030No
			AND (SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0) > 0 --0보다큰값			
	END
	ELSE IF @OrdGbn IN('104')
	BEGIN
		SELECT 
			CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) AS PP030No,
			PS_PP030H.U_OrdGbn AS OrdGbn, --작업구분
			PS_PP030H.U_OrdNum AS OrdNum,
			PS_PP030H.U_OrdSub1 AS OrdSub1,
			PS_PP030H.U_OrdSub2 AS OrdSub2,
			PS_PP030H.DocEntry AS PP030HNo,
			PS_PP030M.LineId AS PP030MNo,
			PS_PP030H.U_SjNum AS ORDRNo,
			PS_PP030H.U_SjLine AS RDR1No,
			PS_PP030H.U_BPLId AS BPLId,
			PS_PP030H.U_ItemCode AS ItemCode,
			PS_PP030H.U_ItemName AS ItemName,
			PS_PP030M.U_CpCode AS CpCode,
			PS_PP030M.U_CpName AS CpName,
			(SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 			
			AS BQty,
			0 AS BWeight,
			(SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 			
			AS PQty,
			0 AS PWeight,
			(SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 			
			AS YQty,
			0 AS YWeight,
			0 AS NQty,
			0 AS NWeight,			
			(SELECT DFLTWH FROM [OITM] WHERE ITEMCODE = PS_PP030H.U_ItemCode) AS WhsCode,
			(SELECT WhsName FROM [OWHS] WHERE WhsCode = (SELECT DFLTWH FROM [OITM] WHERE ITEMCODE = PS_PP030H.U_ItemCode)) AS WhsName,
			PS_PP030H.U_OrdNum AS BatchNum,
			'' AS LineId
		FROM
			[@PS_PP030H] PS_PP030H
			LEFT JOIN [@PS_PP030M] PS_PP030M ON PS_PP030H.DocEntry = PS_PP030M.DocEntry			
			LEFT JOIN
			(SELECT
				PS_PP080L.U_PP030HNo AS PP030HNo,
				PS_PP080L.U_PP030MNo AS PP030MNo
				--SUM(PS_PP080L.U_PQty) AS SelQty,
				--SUM(PS_PP080L.U_PWeight) AS SelWt
			FROM
				[@PS_PP080H] PS_PP080H
				LEFT JOIN [@PS_PP080L] PS_PP080L ON PS_PP080H.DocEntry = PS_PP080L.DocEntry
			WHERE
				PS_PP080H.Canceled = 'N'
			--GROUP BY
				--PS_PP080L.U_PP030HNo,
				--PS_PP080L.U_PP030MNo
			) PS_PP080 ON PS_PP080.PP030HNo = PS_PP030H.DocEntry AND PS_PP080.PP030MNo = PS_PP030M.LineId
		WHERE	
			PS_PP030H.Canceled = 'N'
			AND (SELECT COUNT(*) FROM [@PS_PP040H] PS_PP040H LEFT JOIN [@PS_PP040L] PS_PP040L ON PS_PP040H.DocEntry = PS_PP040L.DocEntry WHERE PS_PP040H.Canceled = 'N' AND PS_PP040L.U_PP030HNo = PS_PP030H.DocEntry AND PS_PP040L.U_PP030MNo = PS_PP030M.LineId) > 0
			AND PS_PP030H.U_OrdGbn IN('104') --멀티
			AND PS_PP030M.U_ResultYN = 'Y' --실적포인트	
			AND PS_PP030H.U_OrdGbn = @OrdGbn --멀티
			AND CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) = @PP030No
			AND PS_PP080.PP030HNo IS NULL --생산완료되지 않은행			
	END
	ELSE IF @OrdGbn IN('102','105','106') --부품,기계,몰드
	BEGIN
		--수주기준
		SELECT
			PS_PP030H.DocEntry AS PP030No,
			PS_PP030H.U_OrdGbn AS OrdGbn, --작업구분
			PS_PP030H.U_OrdNum AS OrdNum,
			PS_PP030H.U_OrdSub1 AS OrdSub1,
			PS_PP030H.U_OrdSub2 AS OrdSub2,
			PS_PP030H.DocEntry AS PP030HNo,
			'' AS PP030MNo,
			PS_PP030H.U_SjNum AS ORDRNo,
			PS_PP030H.U_SjLine AS RDR1No,
			PS_PP030H.U_BPLId AS BPLId,
			PS_PP030H.U_ItemCode AS ItemCode,
			PS_PP030H.U_ItemName AS ItemName,
			'' AS CpCode,
			'' AS CpName,
			(SELECT SUM(Quantity) FROM [RDR1] WHERE DocEntry = PS_PP030H.U_SjNum AND LineNum = PS_PP030H.U_SjLine AND Canceled= 'N') 
			- ISNULL(PS_PP080.SelQty,0) 
			AS BQty,
			(SELECT SUM(Quantity) FROM [RDR1] WHERE DocEntry = PS_PP030H.U_SjNum AND LineNum = PS_PP030H.U_SjLine AND Canceled= 'N')
			- ISNULL(PS_PP080.SelQty,0) --공정이 존재하지 않음
			AS BWeight,
			0 AS PQty,
			0 AS PWeight,
			0 AS YQty,
			0 AS YWeight,
			0 AS NQty,
			0 AS NWeight,
			(SELECT DFLTWH FROM [OITM] WHERE ITEMCODE = PS_PP030H.U_ItemCode) AS WhsCode,
			(SELECT WhsName FROM [OWHS] WHERE WhsCode = (SELECT DFLTWH FROM [OITM] WHERE ITEMCODE = PS_PP030H.U_ItemCode)) AS WhsName,
			CASE WHEN @OrdGbn = '102' 
			THEN (SELECT U_LotNo FROM [ORDR] WHERE DocEntry = PS_PP030H.U_SjNum)
			WHEN @OrdGbn = '105'
			THEN ''
			WHEN @OrdGbn = '106'
			THEN ''
			END AS BatchNum,
			'' AS LineId
		FROM
			[@PS_PP030H] PS_PP030H --일보테이블이랑 관계없다.
			LEFT JOIN
			(SELECT
				PS_PP080L.U_PP030HNo AS PP030HNo,
				PS_PP080L.U_PP030MNo AS PP030MNo,
				SUM(PS_PP080L.U_PQty) AS SelQty,
				SUM(PS_PP080L.U_PWeight) AS SelWt
			FROM
				[@PS_PP080H] PS_PP080H
				LEFT JOIN [@PS_PP080L] PS_PP080L ON PS_PP080H.DocEntry = PS_PP080L.DocEntry
			WHERE
				PS_PP080H.Canceled = 'N'
			GROUP BY
				PS_PP080L.U_PP030HNo,
				PS_PP080L.U_PP030MNo
			) PS_PP080 ON PS_PP080.PP030HNo = PS_PP030H.DocEntry
		WHERE
			PS_PP030H.Canceled = 'N'
			AND PS_PP030H.U_OrdGbn IN('102','105','106') --부품,기계,몰드
			AND PS_PP030H.U_OrdGbn = @OrdGbn --휘팅,멀티,엔드베어링	
			AND CONVERT(NVARCHAR,PS_PP030H.DocEntry) = @PP030No
			AND (SELECT SUM(Quantity) FROM [RDR1] WHERE DocEntry = PS_PP030H.U_SjNum AND LineNum = PS_PP030H.U_SjLine AND Canceled= 'N') 
			- ISNULL(PS_PP080.SelQty,0) > 0
	END
END