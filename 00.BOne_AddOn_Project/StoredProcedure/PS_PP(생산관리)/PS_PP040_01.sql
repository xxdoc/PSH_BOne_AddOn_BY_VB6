IF OBJECT_ID('PS_PP040_01') IS NOT NULL
BEGIN
	DROP PROC PS_PP040_01
END
GO
--EXEC PS_PP040_01 '6-3'
CREATE PROC PS_PP040_01
(	
	@OrdMgNum NVARCHAR(100)
)
AS
BEGIN
	SELECT
		@OrdMgNum AS OrdMgNum,
		PS_PP030M.U_Sequence AS Sequence,
		PS_PP030M.U_CpCode AS CpCode,
		PS_PP030M.U_CpName AS CpName,
		PS_PP030H.U_OrdGbn AS OrdGbn,
		PS_PP030H.U_BPLId AS BPLId,
		PS_PP030H.U_ItemCode AS ItemCode,
		PS_PP030H.U_ItemName AS ItemName,
		PS_PP030H.U_OrdNum AS OrdNum,
		PS_PP030H.U_OrdSub1 AS OrdSub1,
		PS_PP030H.U_OrdSub2 AS OrdSub2,
		PS_PP030H.DocEntry AS PP030HNo,
		PS_PP030M.LineId AS PP030MNo,
		(SELECT ISNULL(SUM(SUB_PS_PP040L.U_PQty),0) FROM [@PS_PP040H] SUB_PS_PP040H LEFT JOIN [@PS_PP040L] SUB_PS_PP040L ON SUB_PS_PP040H.DocEntry = SUB_PS_PP040L.DocEntry WHERE SUB_PS_PP040H.Canceled = 'N' AND SUB_PS_PP040L.U_PP030HNo = PS_PP030H.DocEntry AND SUB_PS_PP040L.U_PP030MNo = PS_PP030M.LineId) AS PSum,
		0 AS BQty
	FROM 
		[@PS_PP030H] PS_PP030H
		LEFT JOIN [@PS_PP030M] PS_PP030M ON PS_PP030H.DocEntry = PS_PP030M.DocEntry
	WHERE
		CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) = @OrdMgNum
		AND PS_PP030H.Canceled = 'N'
		AND PS_PP030M.U_ReportYN = 'Y' --일보여부가 'Y' 인것들
		
	--SELECT * FROM [@PS_PP030H]
	--SELECT * FROM [@PS_PP030M]	
END