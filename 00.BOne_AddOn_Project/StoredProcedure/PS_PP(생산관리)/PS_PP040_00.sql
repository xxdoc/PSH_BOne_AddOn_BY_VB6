IF OBJECT_ID('PS_PP040_00') IS NOT NULL
BEGIN
	DROP PROC PS_PP040_00
END
GO
--EXEC PS_PP040_01 '6-3'
CREATE PROC PS_PP040_00
(	
	@PP030HNo NVARCHAR(100)
)
AS
BEGIN
	SELECT
		CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) AS '작지문서번호',
		PS_PP030M.U_Sequence AS '공정순서',
		PS_PP030M.U_CpCode AS '공정코드',
		PS_PP030M.U_CpName AS '공정명',
		PS_PP030H.U_OrdGbn AS '작업구분',
		PS_PP030H.U_BPLId AS '사업장',
		PS_PP030H.U_ItemCode AS '품목코드',
		PS_PP030H.U_ItemName AS '품목명',
		PS_PP030H.U_OrdNum AS '작지(Main)',
		PS_PP030H.U_OrdSub1 AS 'Sub1',
		PS_PP030H.U_OrdSub2 AS 'Sub2',
		PS_PP030H.DocEntry AS '작지문서번호',
		PS_PP030M.LineId AS '작지문서라인',
		(SELECT ISNULL(SUM(SUB_PS_PP040L.U_PQty),0) FROM [@PS_PP040H] SUB_PS_PP040H LEFT JOIN [@PS_PP040L] SUB_PS_PP040L ON SUB_PS_PP040H.DocEntry = SUB_PS_PP040L.DocEntry WHERE SUB_PS_PP040H.Canceled = 'N' AND SUB_PS_PP040L.U_PP030HNo = PS_PP030H.DocEntry AND SUB_PS_PP040L.U_PP030MNo = PS_PP030M.LineId) AS '생산누계'
	FROM 
		[@PS_PP030H] PS_PP030H
		LEFT JOIN [@PS_PP030M] PS_PP030M ON PS_PP030H.DocEntry = PS_PP030M.DocEntry
	WHERE
		PS_PP030H.DocEntry = @PP030HNo
		AND PS_PP030H.Canceled = 'N'
		AND PS_PP030M.U_ReportYN = 'Y' --일보여부가 'Y' 인것들
		
	--SELECT * FROM [@PS_PP030H]
	--SELECT * FROM [@PS_PP030M]	
END