IF OBJECT_ID('PS_PP070_02') IS NOT NULL
BEGIN
	DROP PROC PS_PP070_02
END
GO
--EXEC PS_PP070_02 '1','101'
CREATE PROC PS_PP070_02
(
	@PP030No NVARCHAR(100),
	@OrdGbn NVARCHAR(50)	
)
AS
BEGIN		
	IF @OrdGbn IN('101') --휘팅일때
	BEGIN
		SELECT 
			CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) AS PP030No,
			PS_PP030H.U_OrdGbn AS OrdGbn, --작업구분
			PS_PP030H.U_OrdNum AS OrdNum,
			PS_PP030H.U_OrdSub1 AS OrdSub1,
			PS_PP030H.U_OrdSub2 AS OrdSub2,
			PS_PP030H.DocEntry AS PP030HNo,
			PS_PP030M.LineId AS PP030MNo,
			PS_PP030H.U_SjNum AS ORDRNo,
			PS_PP030H.U_SjLine AS RDR1No,
			PS_PP030H.U_BPLId AS BPLId,
			PS_PP030H.U_ItemCode AS ItemCode,
			PS_PP030H.U_ItemName AS ItemName,
			PS_PP030M.U_CpCode AS CpCode,
			PS_PP030M.U_CpName AS CpName,
			(SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0) 
			AS CpQty,
			CASE WHEN ISNULL((SELECT U_CpUnWt FROM [@PS_PP004H] WHERE U_ItemCode = PS_PP030H.U_ItemCode AND U_CpCode = PS_PP030M.U_CpCode),0) = 0 
			THEN
			((SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0)) 
			ELSE			
			((SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0)) * ISNULL((SELECT U_CpUnWt/1000 FROM [@PS_PP004H] WHERE U_ItemCode = PS_PP030H.U_ItemCode AND U_CpCode = PS_PP030M.U_CpCode),0)
			END
			AS CpWt,
			0 AS SelQty,
			0 AS SelWt,			
			'' AS LineId
		FROM
			[@PS_PP030H] PS_PP030H
			LEFT JOIN [@PS_PP030M] PS_PP030M ON PS_PP030H.DocEntry = PS_PP030M.DocEntry
			LEFT JOIN
			(SELECT
				PS_PP070L.U_PP030HNo AS PP030HNo,
				PS_PP070L.U_PP030MNo AS PP030MNo,
				SUM(PS_PP070L.U_SelQty) AS SelQty,
				SUM(PS_PP070L.U_SelWt) AS SelWt
			FROM
				[@PS_PP070H] PS_PP070H
				LEFT JOIN [@PS_PP070L] PS_PP070L ON PS_PP070H.DocEntry = PS_PP070L.DocEntry
			WHERE
				PS_PP070H.Canceled = 'N'
			GROUP BY
				PS_PP070L.U_PP030HNo,
				PS_PP070L.U_PP030MNo
			) PS_PP070 ON PS_PP070.PP030HNo = PS_PP030H.DocEntry AND PS_PP070.PP030MNo = PS_PP030M.LineId 
				AND @OrdGbn = '101' --휘팅벌크포장인경우 이므로 휘팅만 해당
			LEFT JOIN
			(SELECT
				PS_PP080L.U_PP030HNo AS PP030HNo,
				PS_PP080L.U_PP030MNo AS PP030MNo,
				SUM(PS_PP080L.U_PQty) AS SelQty,
				SUM(PS_PP080L.U_PWeight) AS SelWt
			FROM
				[@PS_PP080H] PS_PP080H
				LEFT JOIN [@PS_PP080L] PS_PP080L ON PS_PP080H.DocEntry = PS_PP080L.DocEntry
			WHERE
				PS_PP080H.Canceled = 'N'
			GROUP BY
				PS_PP080L.U_PP030HNo,
				PS_PP080L.U_PP030MNo
			) PS_PP080 ON PS_PP080.PP030HNo = PS_PP030H.DocEntry AND PS_PP080.PP030MNo = PS_PP030M.LineId
		WHERE
			PS_PP030H.Canceled = 'N'
			AND PS_PP030H.U_OrdGbn IN('101') --휘팅
			AND PS_PP030M.U_ResultYN = 'Y' --실적포인트	
			AND PS_PP030H.U_OrdGbn = @OrdGbn --휘팅
			AND CONVERT(NVARCHAR,PS_PP030H.DocEntry) + '-' + CONVERT(NVARCHAR,PS_PP030M.LineId) = @PP030No
			AND (SELECT SUM(U_PQty) FROM [@PS_PP040L] WHERE U_PP030HNo = PS_PP030H.DocEntry AND U_PP030MNo = PS_PP030M.LineId AND Canceled= 'N') 
			-ISNULL(PS_PP070.SelQty,0) - ISNULL(PS_PP080.SelQty,0) > 0 --0보다큰값			
	END
END